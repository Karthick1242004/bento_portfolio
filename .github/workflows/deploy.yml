name: Deploy Website
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    - run: npm install
    - run: npm run build
    - run: npm install -g netlify-cli
    - name: Get Stored Domain
      id: get-domain
      run: |
        DOMAIN=$(curl -s https://folio4ubackend-production.up.railway.app/get-subdomain | jq -r ".subdomain")
        if [ -z "$DOMAIN" ]; then
          echo "Error: No domain provided"
          exit 1
        fi
        echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV
    - name: Deploy to Netlify
      run: |
        echo "Deploying to domain: $DOMAIN"
        SITE_INFO=$(netlify sites:list --json || echo "[]")
        SITE_ID=$(echo "$SITE_INFO" | jq -r ".[] | select(.name==\"$DOMAIN\") | .id")
        
        if [ -z "$SITE_ID" ]; then
          echo "Creating new site: $DOMAIN"
          SITE_ID=$(netlify sites:create --name "$DOMAIN" --json | jq -r '.id')
        fi
        
        netlify link --id "$SITE_ID"
        netlify deploy --prod --dir=./dist --message "Deployed via GitHub Actions"
      env:
        NETLIFY_AUTH_TOKEN: "nfp_Mq3Z9Kkht9jmNEEfCYmJGKogzsfhV3SZded7"
